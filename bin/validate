#!/usr/bin/env ruby

# Requires Ruby 1.9+

require 'thor'
require 'mixlib/shellout'

BASE_DIR = File.join(File.dirname(__FILE__), '..')
SHELLOUT_DEFAULTS = { cwd: BASE_DIR, live_stream: $> }

class ValidateCLI < Thor
  desc 'reset', 'resets tests'
  def reset
    run_command 'rm -fr nodes/ clients'
  end

  desc 'install', 'runs install test'
  def install
    run_command 'chef-client -z -o tests::install'
  end

  private
  def run_command(cmd, options = {})
    options = SHELLOUT_DEFAULTS.merge(options)
    cmd = Mixlib::ShellOut.new(cmd, options)
    cmd.run_command
  end

  def run_command!(cmd, options = {})
    cmd = run_command(cmd, options)
    return if cmd.status.success?
    $stderr.print "ERROR: #{cmd.exitstatus}\nSTDOUT:\n#{cmd.stdout}\n\nSTDERR:\n#{cmd.stderr}\n"
    exit 1
  end
end

ValidateCLI.start(ARGV)
